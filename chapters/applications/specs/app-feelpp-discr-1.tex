%!TEX root = ../../../../exa-ma-d7.1.tex

\section{Demonstrator: Elliptic linear PDE: CG}
\label{sec:app:specs:app-feelpp-discr-1}

This demonstrator solves an elliptic linear PDE (heat equation) using a continuous Galerkin approach.

\Cref{tab:app-feelpp-discr-1} describes the specifications of the application.

\begin{table}[ht]
    \centering
    \begin{tblr}{
        colspec = {l X[10cm]},
        row{odd} = {numpexlightergray},
        hlines = {0.1pt, numpexgray},
        vlines = {numpexgray},
        row{1} = {numpexgray, fg=white, font=\bfseries},
    }
        Field & Details \\
        id & \texttt{app-feelpp-discr-1} \\
        name & Discretization \\
        Partners & Unistra \\
        PC & PC1 - ExaMA, PC2 - ExaSoft \\
        Responsible (Permanent) & V. Chabannes; C. Prud'homme \\
        WP7 Engineer & Thomas Saigre (UNISTRA) \\
        work\_package & WP1, WP3 \\
        application\_type & extended-mini-app \\
        purpose &  Solve a PDE (heat, solid mech) with different discretization methods from low to high order \\
        Method-Algorithm WP1 & unstructured mesh, finite element, dG/hdG, cG, spectral element \\
        Method-Algorithm WP2 & \\
        Method-Algorithm WP3 & domain decomposition methods, Krylov solver, preconditioning \\
        Method-Algorithm WP4 & \\
        Method-Algorithm WP5 & \\
        Method-Algorithm WP6 & \\
        WP7 & \\
        outputs & Gmsh, JSON config	JSON small-data, JSON reports, in-house, Markdown or Asciidoc \\
        metrics & \texttt{benchmark-verification}, \texttt{strong-scalability}, \texttt{weak-scalability}, \texttt{io-scaling} \\
        status & benchmark-ready \\
        Benchmark scope & full-system, method-verification, solver-scaling \\
        Framework & Feel++, PETSc \\
        parallel\_framework & MPI, Kokkos \\
        spec\_due & 6/15/2025 \\
        proto\_due & 7/1/2025 \\
        repo\_url & \url{https://github.com/numpex/apps-feelpp}\\
    \end{tblr}
    \caption{Description of the demonstrator \texttt{app-feelpp-discr-1}.}
    \label{tab:app-feelpp-discr-1}
\end{table}



\subsection{Description of the benchmark}


The benchmark known as \emph{thermal bridges} is an example of an application that enables us to validate numerical simulation tools using \Feelpp.
We have developed tests based on the ISO 10211:2017 standard \cite{noauthor_iso_2017}, which provides methodologies for evaluating thermal bridges in building construction.

Thermal bridges are areas within a building envelope where heat flow is different compared to adjacent areas, often resulting in increased heat loss or unwanted condensation.
The standard is intended to ensure that thermal bridges' simulation are accurately computed.
It provides reference values and tolerance on heat temperature and heat flux at several locations of the geometry.

At the mathematical level, we solve an elliptic linear PDE (the heat equation).
We employ continuous Lagrange finite elements of order 1, 2, and 3 ($\mathP_1$, $\mathP_2$, $\mathP_3$)
and analyze the execution time of the main components of the simulation.

\Cref{fig:spec:app-feelpp-discr-1:thermal_bridges:geometry} represents the geometry
of this benchmark and the domain decomposition by material.% the 3D temperature field solution, and an example of mesh partitioning.

\begin{figure}[!ht]
  \centering
  \begin{subfigure}[c]{0.49\textwidth}
    \centering
    \begin{tikzpicture}
        \draw (0, 0) node {\includegraphics[width=\textwidth]{graphics/feelpp/feelpp-benchmark-thermalbridges-geom.png}};
        \begin{scope}[shift={(2.8, -2.8)}, scale=1.5]
            \draw[red!90!black, ->] (0, 0) -- (0.19, -0.22) node[anchor=west] {$x$};
            \draw[green!70!black, ->] (0, 0) -- (0, 0.4) node[anchor=west] {$y$};
            \draw[blue!80!black, ->] (0, 0) -- (-0.43, -0.07) node[anchor=south] {$z$};
        \end{scope}
    \end{tikzpicture}

  \end{subfigure}
  \hfill
  \begin{subfigure}[c]{0.49\textwidth}
    \centering
        \begin{tikzpicture}
        \draw (0, 0) node {\includegraphics[width=\textwidth]{graphics/feelpp/feelpp-benchmark-thermalbridges-geom2.png}};
        \begin{scope}[shift={(2.8, -2.8)}, scale=1.5]
            \draw[red!90!black, ->] (0, 0) -- (-0.24, 0.22) node[anchor=east] {$x$};
            \draw[green!70!black, ->] (0, 0) -- (-0.04, 0.34) node[anchor=west] {$y$};
            \draw[blue!80!black, ->] (0, 0) -- (0.34, 0.2) node[anchor=north] {$z$};
        \end{scope}
    \end{tikzpicture}
  \end{subfigure}
  \caption{Thermal bridges benchmarks - geometry and materials.}
  \label{fig:spec:app-feelpp-discr-1:thermal_bridges:geometry}
\end{figure}





\subsection{Benchmarking tools used}


The performance tools integrated into the \Feelpp-toolboxes framework were used to measure the execution time.

The metrics measured are the execution time of the main components of the simulation.
We enumerate these parts in the following:
\begin{enumerate}
\item \textbf{Init:} load mesh from file system and initialize heat toolbox (finite element context and algebraic data structure).
\item \textbf{Assembly:} calculate and assemble the matrix and right-hand side values obtained using the finite element method.
\item \textbf{Solve:} the linear system by using a preconditioned GMRES.
\item \textbf{Post-process:} compute validation measures (temperature at points and heat flux) and export on the file system a visualization format (EnSight Gold) of the solution.
\end{enumerate}




\subsection{Input/Output Dataset Description}


\subsubsection{Input Data:}
  \begin{itemize}
  \item Meshes: We have generated three levels of mesh called \texttt{M1}, \texttt{M2}
    and \texttt{M3}. These meshes are stored in GMSH format. The statistics can be found in \Cref{tab:spec:app-feelpp-discr-1:thermal_bridges:discr_stat}. We have also prepared for
    each mesh level a collection of partitioned mesh.
    The format used is an in-house mesh format of \Feelpp based on
    JSON+HDF5 file type.
    The GMSH meshes and the partitioned meshes can be found on our Girder
    database management, in the \Feelpp collections.
  \item Setup: Use standard setup of \Feelpp toolboxes. It corresponds to a cfg
    file and JSON file. These config files are present in the GitHub of \Feelpp.
  \item Sif image: \texttt{feelpp:v0.111.0-preview.10-noble-sif}  (stored in the GitHub registry of \Feelpp)
  \end{itemize}

\subsubsection{Output Data:}

The output includes the computed values of validation measure in CSV files format, export visualization files (mesh, partitioning, temperature), and the time taken to perform each simulation step.
Metric:
\begin{itemize}
    \item \texttt{benchmark-verification},
    \item \texttt{strong-scalability},
    \item \texttt{weak-scalability},
    \item \texttt{io-scaling}: time taken by the application to read meshes, and to write the solution on disk (especially reading).
\end{itemize}


\SetTblrInner{rowsep=0pt}
\begin{table}[!ht]
    \centering
    \begin{tblr}{
        colspec={c*{7}{Q[c, cmd=\pgfmathprintnumber]}},
        vlines={numpexgray},
        hlines={numpexgray},
        row{1,2}={bg=numpexgray, fg=white, font=\bfseries, halign=c, cmd=\normalfont},
        rowhead=2, % This option excludes the first two rows from the column command
    }
    \SetCell[c=5]{c}{Mesh properties} & & & & & \SetCell[c=3]{c}{Number of degrees of freedom} & &\\
        Tag & \# points & \# edge & \# faces & \# elements & $\mathP_1$ & $\mathP_2$ & $\mathP_3$ \\
        \texttt{M1} & 193654 & 1299920 & 2164759 & 1058492 & 193654 & 1493574 & 4958253\\
        \texttt{M2} & 1401135 & 9778744 & 16566803 & 8189193 & 1401135 & 11179879 & 37525426\\
        \texttt{M3} & 10572256 & 75307308 & 128722252 & 63987199 & 10572256 & 85879564 & 289909124\\
    \end{tblr}

  \caption{Thermal bridges benchmarks - Statistics on meshes and number of degrees of freedom with respect to finite element approximation}
  \label{tab:spec:app-feelpp-discr-1:thermal_bridges:discr_stat}
\end{table}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Results summary}

The thermal bridges benchmark has been executed on the Discoverer supercomputer at Unistra for the three mesh refinement levels (M1, M2, M3) using finite element approximations of order 1, 2, and 3. The results demonstrate both the accuracy of the numerical method through comparison with ISO 10211:2017 reference values, and the scalability of the implementation across multiple processors.

\subsubsection{Numerical solution}

\Cref{fig:spec:app-feelpp-discr-1:thermal_bridges:visualization} shows the computed temperature field and the mesh partitioning used for parallel computation. The temperature distribution exhibits the expected heat transfer patterns through the thermal bridge, with the coldest regions in blue and the warmest in red. The partitioning visualization (right panel) demonstrates the load balancing strategy employed by the domain decomposition method, where different colors represent different processor domains.

\begin{figure}[!ht]
  \centering
  \begin{subfigure}[c]{0.49\textwidth}
    \centering
    \includegraphics[width=\textwidth]{graphics/feelpp/feelpp-benchmark-thermalbridges-solution.png}
  \end{subfigure}
  \hfill
  \begin{subfigure}[c]{0.49\textwidth}
    \centering
    \includegraphics[width=\textwidth]{graphics/feelpp/feelpp-benchmark-thermalbridges-pid.png}
  \end{subfigure}
  \caption{Thermal bridges benchmarks - temperature solution (left) and
    partitioning example (right)}
  \label{fig:spec:app-feelpp-discr-1:thermal_bridges:visualization}
\end{figure}


\subsubsection{Mesh convergence}

The convergence study validates the numerical accuracy of the \Feelpp implementation against the reference values provided by the ISO 10211:2017 standard. \Cref{fig:spec:app-feelpp-discr-1:thermal_bridges:measures_convergences} presents the convergence of key validation measures as a function of mesh refinement level.

The results demonstrate excellent agreement with reference values (shown as red dashed lines) for all three finite element orders ($\mathP_1$, $\mathP_2$, $\mathP_3$). Key observations include:
\begin{itemize}
\item \textbf{Heat flux measurements:} All three polynomial orders converge to the reference values for heat flow measurements in the $\alpha$, $\beta$, and $\gamma$ environments (46.09 W, 13.89 W, and 59.98 W respectively).
\item \textbf{Temperature measurements:} The minimum surface temperature in the $\alpha$ environment converges to the reference value of 11.32°C across all mesh levels.
\item \textbf{Convergence rates:} Higher-order finite elements ($\mathP_2$ and $\mathP_3$) achieve better accuracy on coarser meshes, demonstrating the efficiency of high-order methods for smooth solutions.
\item \textbf{Tolerance compliance:} All computed values fall within the tolerances specified by the ISO standard, confirming the correctness of the implementation.
\end{itemize}

The benchmark metric \texttt{benchmark-verification} confirms that the \Feelpp thermal toolbox meets the accuracy requirements for building thermal analysis applications.


\begin{figure}[ht]
  \centering
  \captionsetup[subfigure]{justification=centering}

  \pgfplotstableread[col sep=comma]{software/feelpp/WP1/data/thermalbridges_measures.csv}\dataTableMeasures
  \def\myLineWidth{2pt}
  \def\myLineStyleA{loosely dashdotdotted} %dashdotdotted
  \def\myLineStyleB{dashed}
  \def\myLineStyleC{solid}

  \def\myAddPlot#1#2#3#4{
    \addplot[#3,every mark/.append style={solid},
    % x filter/.expression={(\thisrow{PolyOrder} == 1 ?  \pgfmathparse{\thisrow{Mesh}}\pgfmathresult :NaN)},
    % x filter/.expression={ \thisrow{FunctionSpace} == \thisrow{FunctionSpace} ? \pgfmathresult
    % x filter/.expression={(\thisrow{FunctionSpace} == P1 ? \pgfmathresult :NaN )},
      x filter/.code={
        \pgfmathparse{\thisrow{PolyOrder}==#2}
        \ifnum0=\pgfmathresult
        \pgfmathsetmacro{\newx}{nan}
      \else
        \pgfmathsetmacro{\newx}{\thisrow{Mesh}}
      \fi
      \pgfmathparse{\newx}
      },
      y filter/.expression={ #4*\pgfmathresult }
    ] table [x=Mesh, y=#1] {\dataTableMeasures};
  }

  \def\myPlotOutputMeasures#1#2#3#4{
    \resizebox{\textwidth}{0.6172\textwidth}{
      \begin{tikzpicture}
        \begin{axis}[
          width=\textwidth, height=0.6172\textwidth,
          % width=\textwidth, height=1.2\textheight,
          xtick=data,
          xticklabel={M$\pgfmathprintnumber{\tick}$},
          xmajorgrids=true,% xminorgrids=false, minor x tick num=3,
          ymajorgrids=true, yminorgrids=true,
          minor y tick num=2,
          % xticklabel={\pgfmathparse{100*\tick}\pgfmathprintnumber[precision=0]{\pgfmathresult}\%},
          % xticklabel={\pgfmathparse{\tick}\pgfmathprintnumber[fixed,set thousands separator={},precision=0]{\pgfmathresult}},
          xlabel={Mesh levels}, ylabel={#4},
          % legend style={at={(0.5,1)}, anchor=south,font=\small,legend columns=3}
          % legend style={at={(0.,1)}, anchor=north west,font=\small,legend
          % columns=3},
          legend style={at={(0.,1)}, anchor=south west,font=\small,legend columns=4},
          % #2
          ]

          \myAddPlot{#1}{1}{color=customdarkblue,\myLineStyleC,mark=o,line width=\myLineWidth}{#2}
          \addlegendentry{P1}
          \myAddPlot{#1}{2}{color=customcyan,\myLineStyleC,mark=triangle,line width=\myLineWidth}{#2}
          \addlegendentry{P2}
          \myAddPlot{#1}{3}{color=customorange,\myLineStyleC,mark=square,line width=\myLineWidth}{#2}
          \addlegendentry{P3}
          \addplot+[color=red,\myLineStyleB,mark=none,line width=\myLineWidth,every mark/.append style={solid}] coordinates {
            (1,#3) (3,#3)
          };
          \addlegendentry{Ref}

        \end{axis}
      \end{tikzpicture}
    }

  }

  \begin{subfigure}[c]{0.49\textwidth}
    \centering
    \myPlotOutputMeasures{Normal_Heat_Flux_alpha}{1}{46.09}{Heat flow [W]}
    \caption{Heat flow measured in $\alpha$ environment}
  \end{subfigure}
  \hfill
  \begin{subfigure}[c]{0.49\textwidth}
    \centering
    \myPlotOutputMeasures{Normal_Heat_Flux_beta}{1}{13.89}{Heat flow [W]}
    \caption{Heat flow measured in $\beta$ environment}
  \end{subfigure}
  \hfill
  \begin{subfigure}[c]{0.49\textwidth}
    \centering
    \vspace*{0.03\textheight}
    \myPlotOutputMeasures{Normal_Heat_Flux_gamma}{-1}{59.98}{Heat flow [W]} % warning inverse
    \caption{Heat flow measured in $\gamma$ environment}
  \end{subfigure}
  \hfill
  \begin{subfigure}[c]{0.49\textwidth}
    \centering
    \vspace*{0.03\textheight}
    \myPlotOutputMeasures{Statistics_temperature_alpha_min}{1}{11.32}{Temperature
      [°C]}
    \caption{Surface temperature min in $\alpha$ environment}
  \end{subfigure}

  \caption{Thermal bridges benchmarks - Convergence of validation measures compared to references values}
  \label{fig:spec:app-feelpp-discr-1:thermal_bridges:measures_convergences}
\end{figure}



\subsection{Times of execution}

The performance analysis focuses on the scalability of the main computational components: initialization, assembly, solving, and post-processing. Execution times were measured on the Discoverer supercomputer at Unistra for strong scalability tests, where the problem size remains constant while increasing the number of processors.

\Cref{fig:spec:app-feelpp-discr-1:thermal_bridges:performance_times_M1,fig:spec:app-feelpp-discr-1:thermal_bridges:performance_times_M2,fig:spec:app-feelpp-discr-1:thermal_bridges:performance_times_M3} present both grouped and stacked bar charts showing the execution time breakdown for each mesh level and polynomial order. Key performance insights include:

\begin{itemize}
\item \textbf{Initialization:} The mesh loading and toolbox initialization (blue bars) shows good scalability, with decreasing times as processor count increases. This validates the efficiency of the parallel mesh partitioning strategy.

\item \textbf{Assembly:} The finite element assembly phase (cyan bars) represents a significant portion of total time and scales well for all mesh levels. Higher-order elements ($\mathP_3$) require more assembly time due to increased quadrature points and local matrix sizes.

\item \textbf{Post-processing:} The export and validation phase (orange bars) remains relatively constant across processor counts, as it involves I/O operations that are less amenable to parallelization.

\item \textbf{Strong scalability:} The total execution time decreases as the number of processors increases from 1 to 96, demonstrating effective parallel efficiency. The speedup is particularly pronounced for the larger meshes (M2 and M3) where the computational workload per processor remains substantial.

\item \textbf{Load balancing:} The consistent performance across different processor counts indicates effective domain decomposition and minimal load imbalance.
\end{itemize}

The benchmark metrics \texttt{strong-scalability} and \texttt{weak-scalability} confirm that the \Feelpp implementation achieves efficient parallel performance suitable for large-scale thermal analysis applications.


\foreach [expand list=true] \meshId in {1,2,3} {

  \pgfplotstableread[col sep=comma]{software/feelpp/WP1/data/thermalbridges_M\meshId_P1_discoverer.csv}\dataPa
  \pgfplotstableread[col sep=comma]{software/feelpp/WP1/data/thermalbridges_M\meshId_P2_discoverer.csv}\dataPb
  \pgfplotstableread[col sep=comma]{software/feelpp/WP1/data/thermalbridges_M\meshId_P3_discoverer.csv}\dataPc

  \begin{figure}
    \centering
    \def\plotSetup##1{
      {table=##1,column=init,legend=Init,color=customdarkblue},
      {table=##1,legend=Assembly,column=algebraic-assembly,color=customcyan},
      %{table=##1,legend=Solve,column=algebraic-solve,color=customorange},
      {table=##1,legend=PostProcess,column=exportResults,color=customorange}
    }
    \def\chartBarPlot##1##2{
      \barChart[ybar,
      width=\textwidth, height=0.6172\textwidth,
      xticklabels from table={##2}{nProc},
      legend style={at={(0.5,1)}, anchor=south,font=\tiny,legend columns=-1}
      ]{\plotSetup{##1}}
    }
    \def\chartBarStackedPlot##1##2{
      \barChart[ybar stacked,
      width=\textwidth, height=0.6172\textwidth,
      xticklabels from table={##2}{nProc},
      legend style={at={(0.5,1)}, anchor=south,font=\tiny,legend columns=-1}
      ]{\plotSetup{##1}}
    }

    \begin{subfigure}[c]{0.49\textwidth}
      \centering
      \chartBarPlot{dataPa}{\dataPa}
      \caption{\texttt{M\meshId} - \texttt{$P_1$}}
    \end{subfigure}
    \hfill
    \begin{subfigure}[c]{0.49\textwidth}
      \centering
      \chartBarStackedPlot{dataPa}{\dataPa}
      \caption{\texttt{M\meshId} - \texttt{$P_1$}}
    \end{subfigure}
    \hfill
    \vspace*{0.04\textwidth}
    \begin{subfigure}[c]{0.49\textwidth}
      \centering
      \chartBarPlot{dataPb}{\dataPb}
      \caption{\texttt{M\meshId} - \texttt{$P_2$}}
    \end{subfigure}
    \hfill
    \begin{subfigure}[c]{0.49\textwidth}
      \centering
      \chartBarStackedPlot{dataPb}{\dataPb}
      \caption{\texttt{M\meshId} - \texttt{$P_2$}}
    \end{subfigure}
    \hfill
    \vspace*{0.04\textwidth}
    \begin{subfigure}[c]{0.49\textwidth}
      \centering
      \chartBarPlot{dataPc}{\dataPc}
      \caption{\texttt{M\meshId} - \texttt{$P_3$}}
    \end{subfigure}
    \hfill
    \begin{subfigure}[c]{0.49\textwidth}
      \centering
      \chartBarStackedPlot{dataPc}{\dataPc}
      \caption{\texttt{M\meshId} - \texttt{$P_3$}}
    \end{subfigure}
    \caption{Thermal bridges benchmarks - Execution time of main simulation components
      - Mesh \texttt{M\meshId} - Discoverer supercomputer}
    \label{fig:spec:app-feelpp-discr-1:thermal_bridges:performance_times_M\meshId}
  \end{figure}
}

\subsubsection{Scalability on I/O}

The I/O scalability analysis examines the performance of mesh loading and solution export operations as the number of processors and mesh size vary. The benchmark metric \texttt{io-scaling} measures the time required for file system operations during initialization and post-processing phases.

Key I/O performance characteristics observed:
\begin{itemize}
\item \textbf{Parallel mesh loading:} The pre-partitioned mesh format (JSON+HDF5) enables efficient parallel loading, with read times scaling inversely with processor count. The initialization times shown in the performance charts demonstrate this scalability.

\item \textbf{Export operations:} Writing visualization files (EnSight Gold format) exhibits limited scalability due to file system contention when multiple processors write simultaneously. This is evident in the relatively constant post-processing times across different processor counts.

\item \textbf{Mesh size impact:} Larger meshes (M3 with 10.5M vertices) show more pronounced I/O bottlenecks compared to smaller meshes (M1 with 193K vertices), as the absolute amount of data written increases significantly.

\item \textbf{Recommendations:} For production runs, using collective I/O strategies and reducing the frequency of visualization exports can significantly improve overall performance. The HDF5-based mesh format provides good parallel I/O performance for mesh loading operations.
\end{itemize}

These I/O characteristics are typical for large-scale finite element simulations and inform best practices for configuring output frequencies in production simulations.
