name: Compile Latex and Release PDF

on:
  push:
    tags:
      - 'v*'
    branches:
      - '*'
  pull_request:
    branches:
      - 'main'

jobs:
  workflow-setup:
    name: Workflow Setup
    runs-on: ubuntu-24.04
    outputs:
      runner: ${{ steps.texlive_runner.outputs.runner }}
      prefix: ${{ steps.doc_prefix.outputs.prefix }}
      prefixwithref: ${{ steps.doc_prefix.outputs.prefixwithref }}
      pdf: ${{ steps.doc_prefix.outputs.pdf }}
      tex: ${{ steps.doc_prefix.outputs.tex }}
    steps:
      - name: Get TeXLive Runner
        id: texlive_runner
        run: |
          if ! [ -z "$GH_TOKEN" ]; then
            runners=$(gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /orgs/${{ github.repository_owner }}/actions/runners)
            texlive=$(echo $runners | jq --arg label "self-texlive" '[.runners[] | any(.labels[]; .name == $label) and .status == "online"] | any')
            if [ "$texlive" = "false" ]; then
               echo "runner=ubuntu-latest" >> "$GITHUB_OUTPUT"
            else
                echo "runner=self-texlive" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "runner=ubuntu-latest" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.TOKEN_RUNNER }}

      - name: Get Document Prefix
        id: doc_prefix
        run: |
          prefix=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "prefix=$prefix" >> "$GITHUB_OUTPUT"
          
          # Handle different event types for naming
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # For pull requests, use pr-NUMBER format
            prefixwithref=$(echo "$prefix")-pr-${{ github.event.number }}
          else
            # For tags and branches, use the ref name
            prefixwithref=$(echo "$prefix")-${{ github.ref_name }}
          fi
          
          echo "prefixwithref=$prefixwithref" >> "$GITHUB_OUTPUT"
          echo "pdf=$prefixwithref.pdf" >> "$GITHUB_OUTPUT"
          echo "tex=$prefix.tex" >> "$GITHUB_OUTPUT"
      -
        name: Show Outputs
        run: |
          echo "runner=${{ steps.texlive_runner.outputs.runner }}"
          echo "prefix=${{ steps.doc_prefix.outputs.prefix }}"
          echo "prefixwithref=${{ steps.doc_prefix.outputs.prefixwithref }}"
          echo "pdf=${{ steps.doc_prefix.outputs.pdf }}"
          echo "tex=${{ steps.doc_prefix.outputs.tex }}"


  build_latex:
    needs: workflow-setup
    runs-on: ${{ needs.workflow-setup.outputs.runner }}
    name: Build LaTeX Artifact
    env:
      VERSION: ${{ github.ref_name }}
      ZOTERO_API_KEY: ${{ secrets.EXA_MA_ZOTERO_API_KEY }}
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Set up Python and uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: false

      - name: Set up Python
        run: uv python install 3.11

      - name: Create virtual environment and install article-cli
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš¡ Fast Python Setup with UV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Setting up isolated Python environment..." >> $GITHUB_STEP_SUMMARY

          start_time=$(date +%s)
          uv venv .venv --python 3.11
          echo "VIRTUAL_ENV=${PWD}/.venv" >> $GITHUB_ENV
          echo "${PWD}/.venv/bin" >> $GITHUB_PATH
          uv pip install "article-cli>=1.0.3"
          end_time=$(date +%s)
          duration=$((end_time - start_time))

          echo "âœ… **Environment Setup Complete**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tool**: UV (fast Python package installer)" >> $GITHUB_STEP_SUMMARY
          echo "- **Python**: 3.11 (isolated virtual environment)" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: article-cli>=1.0.3" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${duration}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache**: Enabled for faster subsequent runs" >> $GITHUB_STEP_SUMMARY

      - name: Install hooks and setup
        run: |
          article-cli setup
          
          # Add git status to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”§ Git Setup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
          # For pull requests, stay on the current commit; for branches/tags, checkout the ref
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "- **Action**: Staying on PR merge commit" >> $GITHUB_STEP_SUMMARY
            echo "- **PDF Name**: ${{ needs.workflow-setup.outputs.pdf }} (pr-${{ github.event.number }} format)" >> $GITHUB_STEP_SUMMARY
            echo "Pull request detected - staying on current commit ${{ github.sha }}"
          else
            echo "- **Action**: Checking out ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PDF Name**: ${{ needs.workflow-setup.outputs.pdf }} (ref-based format)" >> $GITHUB_STEP_SUMMARY
            echo "Checking out ${{ github.ref }}"
            git checkout ${{ github.ref }}
          fi

      - name: Show article-cli configuration
        run: |
          article-cli --version
          article-cli config show
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”§ Environment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python Environment:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "UV Version: $(uv --version)" >> $GITHUB_STEP_SUMMARY
          echo "Python Version: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "Virtual Environment: $VIRTUAL_ENV" >> $GITHUB_STEP_SUMMARY
          echo "Article CLI: $(article-cli --version)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration Details:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          article-cli config show >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Update bibliography from Zotero
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“š Bibliography Update" >> $GITHUB_STEP_SUMMARY
          echo "Updating bibliography from Zotero group using isolated virtual environment..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if article-cli update-bibtex; then
            echo "âœ… **Bibliography Updated Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Environment**: Isolated venv with uv" >> $GITHUB_STEP_SUMMARY
            echo "- **Source**: Zotero Group 5582837 (ExaMA)" >> $GITHUB_STEP_SUMMARY
            echo "- **Output**: references.bib" >> $GITHUB_STEP_SUMMARY
            echo "- **Backup**: references.bib.backup" >> $GITHUB_STEP_SUMMARY
            if [ -f references.bib ]; then
              entries=$(grep -c "^@" references.bib || echo "0")
              echo "- **Total entries**: $entries" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Bibliography Update Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check Zotero API key and group permissions." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        env:
          ZOTERO_API_KEY: ${{ secrets.EXA_MA_ZOTERO_API_KEY }}

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v3
        if: ${{ needs.workflow-setup.outputs.runner == 'ubuntu-latest' }}
        with:
          root_file: ${{ needs.workflow-setup.outputs.tex }}
          latexmk_shell_escape: true
          post_compile: "latexmk -c; rm -rf _minted*"

      - name: Compile LaTeX document
        if: ${{ needs.workflow-setup.outputs.runner == 'self-texlive' }}
        run: |
          latexmk -shell-escape -pdf -file-line-error -halt-on-error -interaction=nonstopmode  ${{ needs.workflow-setup.outputs.tex }}

      - name: Rename PDF
        run: mv ${{ needs.workflow-setup.outputs.prefix }}.pdf ${{ needs.workflow-setup.outputs.pdf }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.workflow-setup.outputs.prefixwithref }}
          path: |
            ./*.tex
            ./*.bib
            ./*.gin
            ./*.bbl
            ./${{ needs.workflow-setup.outputs.pdf }}
            ./README.adoc
            ./hooks*
            ./img*
            ./dat*
            ./*.png
            ./a.cli
            ./*.sty
            ./chapters*
            ./software*
            ./exclude.txt
            ./sections*
            ./litterature*
            ./graphics*
            !./.git*
            !./.github*
            !./.vscode*
            !./.idea*
            !./.DS_Store*
            !./.gitignore*
  check:
      needs: [build_latex,workflow-setup]
      runs-on: ${{ needs.workflow-setup.outputs.runner }}
      name: Check LaTeX Artifact
      steps:
      -
        name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.workflow-setup.outputs.prefixwithref }}
          path: ${{ github.workspace }}/artifact
      -
        name: List Artifact
        run: ls -R ${{ github.workspace }}
      -
        name: Check compilation of LaTeX document from artifact
        if: ${{ needs.workflow-setup.outputs.runner == 'ubuntu-latest' }}
        uses: xu-cheng/latex-action@v3
        with:
          root_file: ${{ needs.workflow-setup.outputs.tex }}
          latexmk_shell_escape: true
          post_compile: "latexmk -c; rm -rf _minted*"
          working_directory: ${{ github.workspace }}/artifact
      -
        name: Check compilation of LaTeX document from artifact
        if: ${{ needs.workflow-setup.outputs.runner == 'self-texlive' }}
        run: |
          latexmk -shell-escape -pdf -file-line-error -halt-on-error -interaction=nonstopmode  ${{ needs.workflow-setup.outputs.tex }}
        working-directory: ${{ github.workspace }}/artifact

  release:
    needs: [workflow-setup,build_latex, check]
    runs-on: ${{ needs.workflow-setup.outputs.runner }}
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.workflow-setup.outputs.prefixwithref }}
          path: ${{ github.workspace }}/artifact

      - name: Archive Article
        run: |
          temp_dir=$(mktemp -d)
          tar -czvf "${temp_dir}/${{ needs.workflow-setup.outputs.prefixwithref }}.tar.gz" -C artifact ./
          mv "${temp_dir}/${{ needs.workflow-setup.outputs.prefixwithref }}.tar.gz" ./
          rm -rf "$temp_dir"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') || contains(github.ref, 'preview') }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          tag_name: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            artifact/${{ needs.workflow-setup.outputs.prefixwithref }}.pdf
            ${{ needs.workflow-setup.outputs.prefixwithref }}.tar.gz